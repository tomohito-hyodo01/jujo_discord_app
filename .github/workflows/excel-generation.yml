name: Tournament Excel Generation

# ÊØéÊó•ÂçàÂâç9ÊôÇÔºàJST = UTC 0:00Ôºâ„Å´Ëá™ÂãïÂÆüË°å
on:
  schedule:
    - cron: '0 0 * * *'  # ÊØéÊó• UTC 0:00 = JST 9:00
  workflow_dispatch:  # ÊâãÂãïÂÆüË°å„ÇÇÂèØËÉΩ

jobs:
  generate-excel:
    name: Generate Excel for Upcoming Deadlines
    runs-on: ubuntu-latest

    steps:
      - name: Call Excel Generation API
        id: generate
        run: |
          echo "üìä Checking tournaments with deadline tomorrow..."

          # „É™„Éà„É©„Ç§„É≠„Ç∏„ÉÉ„ÇØÔºàÊúÄÂ§ß3ÂõûË©¶Ë°åÔºâ
          max_retries=3
          retry_count=0
          success=false

          while [ $retry_count -lt $max_retries ]; do
            echo "Attempt $((retry_count + 1))/$max_retries..."

            response=$(curl -s -w "\n%{http_code}" -X POST \
              --max-time 300 \
              --connect-timeout 30 \
              "https://tournament-api-jujo.fly.dev/api/excel/process-deadlines" \
              -H "Content-Type: application/json")

            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | sed '$d')

            echo "HTTP Status: $http_code"
            echo "Response: $body"

            if [ "$http_code" -eq 200 ]; then
              echo "‚úÖ Excel generation completed successfully!"

              # „É¨„Çπ„Éù„É≥„Çπ„Åã„ÇâÂá¶ÁêÜÁµêÊûú„ÇíÊäΩÂá∫
              processed_count=$(echo "$body" | grep -o '"processed_count":[0-9]*' | cut -d':' -f2)
              success_count=$(echo "$body" | grep -o '"success_count":[0-9]*' | cut -d':' -f2)

              echo "üìà Processed: $processed_count tournaments"
              echo "‚úÖ Success: $success_count tournaments"

              # ÁµêÊûú„ÇíÂá∫ÂäõÂ§âÊï∞„Å´‰øùÂ≠ò
              echo "processed_count=$processed_count" >> $GITHUB_OUTPUT
              echo "success_count=$success_count" >> $GITHUB_OUTPUT
              echo "response_body=$body" >> $GITHUB_OUTPUT

              success=true
              break
            else
              echo "‚ö†Ô∏è Attempt $((retry_count + 1)) failed (HTTP $http_code)"
              retry_count=$((retry_count + 1))

              if [ $retry_count -lt $max_retries ]; then
                echo "Waiting 30 seconds before retry..."
                sleep 30
              fi
            fi
          done

          if [ "$success" = false ]; then
            echo "‚ùå Failed to generate Excel files after $max_retries attempts"
            echo "response_body=$body" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Report Status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "üìä Excel generation successful at $(date)"
            echo "Processed: ${{ steps.generate.outputs.processed_count }} tournaments"
            echo "Success: ${{ steps.generate.outputs.success_count }} tournaments"
          else
            echo "‚ö†Ô∏è Excel generation failed at $(date)"
            echo "Response: ${{ steps.generate.outputs.response_body }}"
          fi
