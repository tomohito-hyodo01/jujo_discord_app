"""
Excel編集サービス

江戸川区の大会申込Excelファイルを生成する
"""
import openpyxl
from pathlib import Path
from datetime import datetime, date
from typing import List, Dict, Optional
import shutil
from dateutil.relativedelta import relativedelta


# 種別のカスタムソート順序
TYPE_ORDER = {
    "一般": 0,
    "35": 1,
    "45": 2,
    "55": 3,
    "65": 4,
}


class ExcelService:
    """Excel編集サービス"""

    def __init__(self, ward_id: int = 23):
        """
        初期化

        Args:
            ward_id: 区ID（デフォルト: 23=江戸川区）
        """
        self.ward_id = ward_id
        self.template_dir = Path("templates/wards/23_江戸川区")
        self.output_dir = Path("output")
        self.output_dir.mkdir(exist_ok=True)

    def generate_tournament_files(
        self,
        tournament: Dict,
        registrations: List[Dict]
    ) -> Dict[str, str]:
        """
        大会申込Excelファイルを生成

        Args:
            tournament: 大会情報 (tournament_mst)
            registrations: 申込データリスト (tournament_registration + player_mst)

        Returns:
            生成されたファイルパスの辞書
            {
                "member_registration": "output/会員登録表_xxx.xlsx",
                "individual_application": "output/個人戦申込書_xxx.xlsx"
            }
        """
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        tournament_name = tournament['tournament_name']

        result = {}

        # 1. 会員登録表の生成
        member_file = self._generate_member_registration(
            tournament_name,
            registrations,
            timestamp
        )
        result["member_registration"] = str(member_file)

        # 2. 個人戦申込書の生成
        individual_file = self._generate_individual_application(
            tournament,
            registrations,
            timestamp
        )
        result["individual_application"] = str(individual_file)

        return result

    def _generate_member_registration(
        self,
        tournament_name: str,
        registrations: List[Dict],
        timestamp: str
    ) -> Path:
        """
        会員登録表を生成

        Args:
            tournament_name: 大会名
            registrations: 申込データリスト
            timestamp: タイムスタンプ

        Returns:
            生成されたファイルパス
        """
        # テンプレートをコピー
        template_file = self.template_dir / "会員登録表フォーマット.xlsx"
        output_filename = f"{tournament_name}_会員登録表_{timestamp}.xlsx"
        output_path = self.output_dir / output_filename

        shutil.copy(template_file, output_path)

        # Excelを開く
        wb = openpyxl.load_workbook(output_path)
        ws = wb["Sheet1"]

        # edogawa_flg=False の選手のみ抽出
        players_to_write = []

        for reg in registrations:
            # 申込者（discord_id に紐づく選手）
            applicant = reg.get('applicant')
            if applicant and not applicant.get('edogawa_flg', True):
                players_to_write.append(applicant)

            # ペア相手（pair1 に紐づく選手）
            partner = reg.get('partner')
            if partner and not partner.get('edogawa_flg', True):
                players_to_write.append(partner)

        # 重複除去（同じ選手が複数回出てくる可能性）
        unique_players = {}
        for player in players_to_write:
            player_id = player['player_id']
            if player_id not in unique_players:
                unique_players[player_id] = player

        players_to_write = list(unique_players.values())

        # データ書き込み（6行目から）
        for idx, player in enumerate(players_to_write):
            row = 6 + idx

            # A列: No
            ws[f'A{row}'] = idx + 1

            # BC列: 氏名（結合セル）
            ws[f'B{row}'] = player['player_name']

            # D列: 生年月日
            birth_date = player['birth_date']
            if isinstance(birth_date, str):
                birth_date = datetime.strptime(birth_date, "%Y-%m-%d").date()
            ws[f'D{row}'] = birth_date

            # E列: 年齢（計算式を維持するため、ここでは触らない）
            # ※テンプレートに既に計算式が入っているため

            # F列: 性別
            sex = player['sex']
            ws[f'F{row}'] = "男" if sex == 0 else "女"

            # G列: 郵便番号
            ws[f'G{row}'] = player.get('post_number', '')

            # H列: 現住所（結合セルH-J）
            ws[f'H{row}'] = player['address']

            # KL列: 電話（結合セルK-L）
            ws[f'K{row}'] = player['phone_number']

        # 保存
        wb.save(output_path)
        wb.close()

        return output_path

    def _generate_individual_application(
        self,
        tournament: Dict,
        registrations: List[Dict],
        timestamp: str
    ) -> Path:
        """
        個人戦申込書を生成

        Args:
            tournament: 大会情報
            registrations: 申込データリスト
            timestamp: タイムスタンプ

        Returns:
            生成されたファイルパス
        """
        # テンプレートをコピー
        template_file = self.template_dir / "個人戦_申込書フォーマット.xlsx"
        output_filename = f"{tournament['tournament_name']}_個人戦申込書_{timestamp}.xlsx"
        output_path = self.output_dir / output_filename

        shutil.copy(template_file, output_path)

        # Excelを開く
        wb = openpyxl.load_workbook(output_path)
        ws = wb["Sheet1"]

        # A1: 大会名を設定
        ws['A1'] = f"{tournament['tournament_name']}　申込書"

        # F3: 申込日を設定
        today = datetime.now()
        date_str = f"申　込　日　令和{today.year - 2018}年{today.month:02d}月{today.day:02d}日"
        ws['F3'] = date_str

        # 団体名・責任者・連絡先（5-7行目）は空欄のまま（手動入力）

        # 申込データをカスタムソート
        sorted_registrations = self._sort_registrations(registrations)

        # データ書き込み（10行目から）
        row = 10
        entry_no = 1

        for reg in sorted_registrations:
            # 種別文字列の生成
            type_str = self._format_type_sex(reg['type'], reg['sex'])

            # 申込者とペア相手のデータ
            applicant = reg.get('applicant')
            partner = reg.get('partner')

            # 2行書き込み（申込者 + ペア）
            players = [applicant, partner]

            for player in players:
                if player is None:
                    continue

                # A列: NO
                ws[f'A{row}'] = entry_no

                # B列: 種別
                ws[f'B{row}'] = type_str

                # C列: 氏名
                ws[f'C{row}'] = player['player_name']

                # D列: 生年月日
                birth_date = player['birth_date']
                if isinstance(birth_date, str):
                    birth_date = datetime.strptime(birth_date, "%Y-%m-%d").date()
                ws[f'D{row}'] = birth_date

                # E列: 所属名
                ws[f'E{row}'] = player.get('affiliated_club', '')

                # F列: 備考は空欄

                row += 1

            entry_no += 1

        # 保存
        wb.save(output_path)
        wb.close()

        return output_path

    def _sort_registrations(self, registrations: List[Dict]) -> List[Dict]:
        """
        申込データをカスタムソート

        順序: 一般男子 → 35男子 → 45男子 → 一般女子 → 35女子 → 45女子

        Args:
            registrations: 申込データリスト

        Returns:
            ソートされた申込データリスト
        """
        return sorted(
            registrations,
            key=lambda r: (
                r['sex'],  # 0(男子)が先、1(女子)が後
                TYPE_ORDER.get(r['type'], 999)  # 一般→35→45→55...
            )
        )

    def _format_type_sex(self, type_: str, sex: int) -> str:
        """
        種別と性別を結合して文字列化

        Args:
            type_: 種別（"一般", "35", "45"など）
            sex: 性別（0:男子, 1:女子）

        Returns:
            結合文字列（例: "一般男子", "35女子"）
        """
        sex_str = "男子" if sex == 0 else "女子"
        return f"{type_}{sex_str}"

    def _calculate_age(self, birth_date: date, reference_date: Optional[date] = None) -> int:
        """
        年齢を計算

        Args:
            birth_date: 生年月日
            reference_date: 基準日（Noneの場合は現在日時）

        Returns:
            年齢
        """
        if reference_date is None:
            reference_date = date.today()

        age = relativedelta(reference_date, birth_date).years
        return age
